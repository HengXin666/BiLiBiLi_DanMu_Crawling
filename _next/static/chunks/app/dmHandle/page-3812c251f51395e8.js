(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[434],{45949:(e,s,l)=>{Promise.resolve().then(l.bind(l,74008))},60518:(e,s,l)=>{"use strict";l.d(s,{D:()=>r,V:()=>n});var t=l(85839);let r=(0,t.tv)({base:"tracking-tight inline font-semibold",variants:{color:{violet:"from-[#FF1CF7] to-[#b249f8]",yellow:"from-[#FF705B] to-[#FFB457]",blue:"from-[#5EA2EF] to-[#0072F5]",cyan:"from-[#00b7fa] to-[#01cfea]",green:"from-[#6FEE8D] to-[#17c964]",pink:"from-[#FF72E1] to-[#F54C7A]",foreground:"dark:from-[#FFFFFF] dark:to-[#4B4B4B]"},size:{sm:"text-3xl lg:text-4xl",md:"text-[2.3rem] lg:text-5xl leading-9",lg:"text-4xl lg:text-6xl"},fullWidth:{true:"w-full block"}},defaultVariants:{size:"md"},compoundVariants:[{color:["violet","yellow","blue","cyan","green","pink","foreground"],class:"bg-clip-text text-transparent bg-gradient-to-b"}]}),n=(0,t.tv)({base:"w-full md:w-1/2 my-2 text-lg lg:text-xl text-default-600 block max-w-full",variants:{fullWidth:{true:"!w-full"}},defaultVariants:{fullWidth:!0}})},72237:(e,s,l)=>{"use strict";l.d(s,{o:()=>r});var t=l(11046);let r={success:(e,s)=>{(0,t.$U)({title:e,description:s,color:"success"})},error:(e,s)=>{(0,t.$U)({title:e,description:s,color:"danger"})},info:(e,s)=>{(0,t.$U)({title:e,description:s,color:"default"})},warning:(e,s)=>{(0,t.$U)({title:e,description:s,color:"warning"})}}},74008:(e,s,l)=>{"use strict";l.r(s),l.d(s,{default:()=>T});var t=l(60881),r=l(29655),n=l(11978),i=l(18093),a=l(40440),o=l(25151),c=l(58889),d=l(36073),x=l(60614),m=l(17181),h=l(91529),f=l(63752),p=l(51477),u=l(28781),j=l(38912),g=l(61858),y=l(95701),b=l(48209),v=l(96376),S=l(72237),F=l(60518);function N(e){let{url:s,fileType:l}=e;return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)("h2",{className:(0,F.V)(),children:"导入信息"}),(0,t.jsxs)("div",{className:"flex flex-col gap-2",children:[s&&(0,t.jsx)(d.r,{isReadOnly:!0,label:"弹幕来源(Blob)",labelPlacement:"outside",type:"url",value:s,variant:"bordered"}),(0,t.jsx)(d.r,{isReadOnly:!0,label:"弹幕来源文件类型",labelPlacement:"outside",type:"text",value:l||"未知",variant:"bordered"})]})]})}function w(e){let{dmPool:s}=e,l=(0,y.useMemo)(()=>s.shared,[s]);return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)("h2",{className:(0,F.V)(),children:"弹幕库信息"}),(0,t.jsxs)("div",{className:"flex flex-col gap-2",children:[(0,t.jsx)(c.P,{isReadOnly:!0,label:"弹幕数量",type:"number",value:s.dans.length,variant:"bordered"}),(0,t.jsx)(d.r,{isReadOnly:!0,description:"def_<platform>+<cid>@<platform>",label:"弹幕资源ID(SOID)",type:"email",value:l.SOID,variant:"bordered"}),(0,t.jsx)(d.r,{isReadOnly:!0,label:"弹幕来源",type:"text",value:l.platform,variant:"bordered"}),(0,t.jsx)(d.r,{isReadOnly:!0,description:"经过多次格式转换可能会带来意料之外的错误结果",isInvalid:s.info.fromConverted,label:"是否经过多次格式转换",type:"text",value:s.info.fromConverted?"是(极有可能转换出错误的结果)":"否(正常使用)",variant:"bordered"})]})]})}function P(e){let{dmPool:s}=e,l=(0,y.useMemo)(()=>s.most,[s]);return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)("h2",{className:(0,F.V)(),children:"统计信息"}),(0,t.jsxs)("div",{className:"flex flex-col gap-2",children:[(0,t.jsx)(d.r,{isReadOnly:!0,label:"出现最多的内容",type:"text",value:l.content,variant:"bordered"}),(0,t.jsx)(d.r,{isReadOnly:!0,description:"<midHash>@bili，对midHash逆推可得用户的mid",label:"发言最多的用户ID",type:"email",value:l.senderID,variant:"bordered"})]})]})}let O=b.HQ.create();function T(){let e=(0,g.useSearchParams)(),s=(0,g.useRouter)(),l=e.get("url")||"",T=e.get("fn")||"",[A,C]=(0,y.useState)("xml"),[D,B]=(0,y.useState)(T),[k,R]=(0,y.useState)(O),[I,V]=(0,y.useState)(),[E,H]=(0,y.useState)(10),[M,L]=(0,y.useState)(),U=(0,r.j)(),[J,_]=(0,y.useState)(v.$j),Q=(0,y.useMemo)(()=>""!==D&&/[ \/\\\*\?\<\>\|":]/.test(D),[D]),X=async()=>{let e=e=>S.o.error("弹幕导入失败",e),t=()=>S.o.success("弹幕导入成功");if(l)await fetch(l).then(e=>e.text()).then(e=>{V("bili.xml"),R(b.HQ.fromBiliXML(e)),t()}).catch(()=>{e(),s.push("/dmHandle")});else{let s=M?await M.getFile():await (0,v.lt)([{description:"bili xml 弹幕",mimeTypes:["application/xml"],extensions:[".xml"]},{description:"ProtoBuf 弹幕",mimeTypes:["application/octet-stream"],extensions:[".bin",".so"]},{description:"JSON 弹幕",mimeTypes:["application/json"],extensions:[".json"]},{description:"ASS 弹幕",mimeTypes:["text/x-ssa"],extensions:[".ass"]}]).catch(e=>{let s=String(e);S.o.error("弹幕导入失败",s.includes("aborted")?"用户手动取消文件选择":s)});if(!s)return;!M&&s.handle&&L(s.handle);let l=s.name,r=(e=>{let s=e.split(".");return s.length>1?s.pop():""})(l),n=l.replaceAll(".".concat(r),"");if("bin"===r&&n.endsWith(".pb")&&(r="pb.bin",n=n.replaceAll(".pb","")),r&&C(r),B(n),"xml"===r)try{V("bili.xml"),R(b.HQ.fromBiliXML(await s.text()))}catch(s){V(void 0),e("解析XML失败，该XML不是bili格式[".concat(s,"]]"))}else if("ass"===r)try{let e=b.HQ.fromASS(await s.text());if(0===e.dans.length)throw Error("该ASS不含恢复信息");V("common.ass"),R(e)}catch(s){V(void 0),e("解析ASS失败[".concat(s,"]"))}else if("json"===r)try{let e=b.HQ.import(await s.text());V(e.fmt),R(e.pool)}catch(s){V(void 0),e("解析JSON失败[".concat(s,"]"))}else try{let e=b.HQ.import(await s.arrayBuffer());V(e.fmt),R(e.pool)}catch(s){V(void 0),e("解析二进制文件失败[".concat(s,"]"))}t()}},$=(e,s)=>{if(C(s),J)(0,v.Ai)(new Blob([e]),{fileName:D+"."+s,extensions:["."+s],startIn:"downloads"},null).catch(e=>{let s=String(e);S.o.error("弹幕导出失败",s.includes("aborted")?"用户手动取消导出":s)}),S.o.success("弹幕已导出");else U.onOpen()};return(0,t.jsxs)("div",{className:"flex flex-col gap-4",children:[(0,t.jsx)("h1",{className:(0,F.D)(),children:"弹幕处理"}),(0,t.jsx)(N,{fileType:I,url:l}),(0,t.jsx)(n.y,{}),k.dans.length>0&&!k.info.fromConverted||(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(i.T,{color:"primary",onPress:X,children:"读取弹幕"}),(0,t.jsxs)("div",{className:"text-sm text-gray-400",children:["点击",(0,t.jsx)(a.i,{children:"读取弹幕"}),"后，在打开的窗口可选择弹幕类型以筛选文件，也可选择全部文件挑选文件。",(0,t.jsx)("br",{}),"只有",(0,t.jsx)(o.I,{color:"foreground",content:"完全支持",offset:-3,children:(0,t.jsx)(a.i,{children:"@dan-uni/dan-any"})}),"及",(0,t.jsx)(o.I,{color:"foreground",content:"兼容性支持",offset:-3,children:(0,t.jsx)(a.i,{children:"biliy"})}),"导出的ASS可以被还原。"]})]}),k.dans.length>0&&(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(w,{dmPool:k}),(0,t.jsx)(n.y,{}),(0,t.jsx)(P,{dmPool:k}),(0,t.jsx)(n.y,{}),k.info.fromConverted||(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)("h2",{className:(0,F.V)(),children:"处理选项"}),(0,t.jsxs)("div",{className:"flex flex-wrap gap-4 items-center",children:[(0,t.jsx)("div",{children:(0,t.jsx)(i.T,{color:"danger",onPress:X,children:"还原全部处理"})}),(0,t.jsx)(n.y,{}),(0,t.jsxs)("div",{className:"flex flex-col gap-2 lg:flex-row",children:[(0,t.jsx)(c.P,{description:"合并一定时间段内的重复弹幕，防止同屏出现过多[0表示不查重]",endContent:(0,t.jsx)("div",{className:"pointer-events-none flex items-center",children:(0,t.jsx)("span",{className:"text-default-400 text-small",children:"秒"})}),label:"去重合并弹幕阈值(查重时间区段)",type:"number",value:E,onValueChange:e=>H(e)}),(0,t.jsx)(i.T,{color:"primary",onPress:()=>{R(k.merge(E)),S.o.success("去重成功")},children:"去重(基础)"})]})]})]}),(0,t.jsx)(n.y,{})]}),(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)("h2",{className:(0,F.V)(),children:"导出设置"}),(0,t.jsxs)(t.Fragment,{children:[k.info.fromConverted||(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(d.r,{isRequired:!0,endContent:(0,t.jsx)("div",{className:"pointer-events-none flex items-center",children:(0,t.jsxs)("span",{className:"text-default-400 text-small",children:[".",A]})}),isInvalid:Q,label:"文件名称",labelPlacement:"outside",type:"text",value:D,variant:"bordered",onValueChange:B}),(0,t.jsxs)("div",{className:"flex flex-col gap-2 lg:flex-row",children:[(0,t.jsx)(i.T,{color:"primary",onPress:()=>{$(k.toBiliXML(),"xml")},children:"Bili(XML)"}),(0,t.jsx)(i.T,{color:"primary",onPress:()=>{let e=document.createElement("canvas");e.width=50,e.height=50;let s=e.getContext("2d");$(k.toASS(s,{filename:"".concat(D,".xml"),title:D,raw:{compressType:"gzip",baseType:"base18384"}}),"ass")},children:"ASS"}),(0,t.jsxs)(x.x,{children:[(0,t.jsx)(i.T,{color:"primary",onPress:()=>{$(JSON.stringify(k.dans),"json")},children:"DanUni(JSON)"}),(0,t.jsx)(i.T,{color:"secondary",onPress:()=>{$(k.toPb(),"pb.bin")},children:"DanUni(ProtoBuf)"})]}),(0,t.jsxs)(x.x,{children:[(0,t.jsx)(i.T,{color:"primary",onPress:()=>{$(JSON.stringify(k.toDplayer()),"json")},children:"Dplayer"}),(0,t.jsx)(i.T,{color:"secondary",onPress:()=>{$(JSON.stringify(k.toArtplayer()),"json")},children:"Artplayer"}),(0,t.jsx)(i.T,{color:"default",onPress:()=>{$(JSON.stringify(k.toDDplay()),"json")},children:"弹弹Play"})]})]}),(0,t.jsx)(m.Y,{isOpen:U.isOpen,onOpenChange:U.onOpenChange,children:(0,t.jsx)(h.g,{children:e=>(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(f.c,{children:"⚠️ 兼容性警告"}),(0,t.jsxs)(p.h,{children:[(0,t.jsxs)("p",{children:["当前环境不支持",(0,t.jsx)(u.m,{color:"primary",children:"FileSystemAccessAPI"}),"，点击保存将可能直接存储至",(0,t.jsx)(u.m,{children:"下载"}),"或",(0,t.jsx)(u.m,{children:"Downloads"}),"文件夹。"]}),(0,t.jsx)("p",{children:"确认后再次点击导出格式对应按钮即可保存。"})]}),(0,t.jsxs)(j.q,{children:[(0,t.jsx)(i.T,{color:"danger",variant:"flat",onPress:e,children:"取消"}),(0,t.jsx)(i.T,{color:"primary",onPress:()=>{_(!0),e()},children:"我已知悉"})]})]})})})]}),(0,t.jsx)(i.T,{color:"danger",onPress:()=>{let e=()=>S.o.success("导出弹幕完成","已释放缓存");l?(URL.revokeObjectURL(l),e(),s.push("/crawl")):(V(void 0),R(O),L(void 0),e())},children:"确认导出完成(退出)"})]})]})]})]})}}},e=>{e.O(0,[627,302,191,192,151,253,786,987,803,447,358],()=>e(e.s=45949)),_N_E=e.O()}]);