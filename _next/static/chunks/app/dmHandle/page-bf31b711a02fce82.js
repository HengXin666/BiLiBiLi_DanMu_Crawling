(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[434],{37247:(e,s,t)=>{"use strict";t.r(s),t.d(s,{default:()=>A});var n=t(60881),l=t(29655),r=t(11978),a=t(18093),i=t(40440),o=t(25151),c=t(58889),d=t(36073),x=t(60614),m=t(17181),h=t(91529),f=t(63752),u=t(51477),p=t(28781),j=t(38912),g=t(61858),y=t(95701),b=t(89964),v=t(96376),S=t(72237),w=t(60518);function F(e){let{url:s,fileType:t}=e;return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)("h2",{className:(0,w.V)(),children:"导入信息"}),(0,n.jsxs)("div",{className:"flex flex-col gap-2",children:[s&&(0,n.jsx)(d.r,{isReadOnly:!0,label:"弹幕来源(Blob)",labelPlacement:"outside",type:"url",value:s,variant:"bordered"}),(0,n.jsx)(d.r,{isReadOnly:!0,label:"弹幕来源文件类型",labelPlacement:"outside",type:"text",value:t||"未知",variant:"bordered"})]})]})}function N(e){let{dmPool:s}=e,t=(0,y.useMemo)(()=>({SOID:s.getShared("SOID"),platform:s.getShared("platform")}),[s]);return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)("h2",{className:(0,w.V)(),children:"弹幕库信息"}),(0,n.jsxs)("div",{className:"flex flex-col gap-2",children:[(0,n.jsx)(c.P,{isReadOnly:!0,label:"弹幕数量",type:"number",value:s.dans.length,variant:"bordered"}),(0,n.jsx)(d.r,{isReadOnly:!0,description:"def_<platform>+<cid>@<platform>",label:"弹幕资源ID(SOID)",type:"email",value:t.SOID,variant:"bordered"}),(0,n.jsx)(d.r,{isReadOnly:!0,label:"弹幕来源",type:"text",value:t.platform,variant:"bordered"}),(0,n.jsx)(d.r,{isReadOnly:!0,description:"经过多次格式转换可能会带来意料之外的错误结果",isInvalid:s.info.fromConverted,label:"是否经过多次格式转换",type:"text",value:s.info.fromConverted?"是(极有可能转换出错误的结果)":"否(正常使用)",variant:"bordered"})]})]})}var P=t(28669);function O(e){for(var s=arguments.length,t=Array(s>1?s-1:0),n=1;n<s;n++)t[n-1]=arguments[n];return new Promise(s=>{setTimeout(()=>s(e(...t)),0)})}let T=(0,y.memo)(function(e){let{dmPoolMost:s}=e,t=(0,y.use)(s);return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(d.r,{isReadOnly:!0,label:"出现最多的内容",type:"text",value:t.content.val,variant:"bordered"}),(0,n.jsx)(d.r,{isReadOnly:!0,description:"<midHash>@bili，对midHash逆推可得用户的mid",label:"发言最多的用户ID",type:"email",value:t.senderID.val,variant:"bordered"})]})}),D=(0,y.memo)(function(e){let{dmPool:s,limit:t=6e3}=e,[l,r]=(0,y.useState)(s.dans.length<=t),i=(0,y.useMemo)(()=>(r(s.dans.length<=t),s),[s]);return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)("h2",{className:(0,w.V)(),children:"统计信息"}),(0,n.jsx)("div",{className:"flex flex-col gap-2",children:l?(0,n.jsx)(y.Suspense,{fallback:(0,n.jsx)(P.o,{variant:"wave"}),children:(0,n.jsx)(T,{dmPoolMost:O(function(e){return{content:e.getMost("content"),senderID:e.getMost("senderID")}},i)})}):(0,n.jsxs)("div",{className:"text-center justify-center",children:[(0,n.jsx)("p",{children:"该弹幕库条目过多，统计操作可能会造成不可预期的卡顿、无响应。"}),(0,n.jsx)(a.T,{className:"mt-2",color:"warning",onPress:()=>r(!0),children:"我已知悉"})]})})]})}),C=b.HQ.create();function A(){let e=(0,g.useSearchParams)(),s=(0,g.useRouter)(),t=e.get("url")||"",P=e.get("fn")||"",[T,A]=(0,y.useState)("xml"),[I,B]=(0,y.useState)(P),[L,k]=(0,y.useState)(C),[M,R]=(0,y.useState)(),[V,E]=(0,y.useState)(10),[H,U]=(0,y.useState)(),J=(0,l.j)(),[_,Q]=(0,y.useState)(v.$j),[X,$]=(0,y.useTransition)(),[W,z]=(0,y.useState)(!1),q=X||W,Y=(0,y.useMemo)(()=>""!==I&&/[ \/\\\*\?\<\>\|":]/.test(I),[I]),G=async()=>{let e=e=>{S.o.error("弹幕导入失败",e),R(void 0),z(!1)},n=()=>{S.o.success("弹幕导入成功"),z(!1)};if(z(!0),t)await fetch(t).then(e=>e.text()).then(async e=>{R("bili.xml"),k(await O(()=>b.HQ.fromBiliXML(e))),n()}).catch(()=>{e(),s.push("/dmHandle")});else{let s=H&&!L.info.fromConverted?await H.getFile():await (0,v.lt)([{description:"bili xml 弹幕",mimeTypes:["application/xml"],extensions:[".xml"]},{description:"ProtoBuf 弹幕",mimeTypes:["application/octet-stream"],extensions:[".bin",".so"]},{description:"JSON 弹幕",mimeTypes:["application/json"],extensions:[".json"]},{description:"ASS 弹幕",mimeTypes:["text/x-ssa"],extensions:[".ass"]}]).catch(e=>{let s=String(e);S.o.error("弹幕导入失败",s.includes("aborted")?"用户手动取消文件选择":s),z(!1)});if(!s)return;!(H&&!L.info.fromConverted)&&s.handle&&U(s.handle);let t=s.name,l=(e=>{let s=e.split(".");return s.length>1?s.pop():""})(t),r=t.replaceAll(".".concat(l),"");if("bin"===l&&r.endsWith(".pb")&&(l="pb.bin",r=r.replaceAll(".pb","")),l&&A(l),B(r),"xml"===l)try{R("bili.xml"),k(await O(async()=>b.HQ.fromBiliXML(await s.text())))}catch(s){e("解析XML失败，该XML不是bili格式[".concat(s,"]]"))}else if("ass"===l)try{let e=await O(async()=>b.HQ.fromASS(await s.text()));if(0===e.dans.length)throw Error("该ASS不含恢复信息");R("common.ass"),k(e)}catch(s){e("解析ASS失败[".concat(s,"]"))}else if("json"===l)try{let e=await O(async()=>b.HQ.import(await s.text()));R(e.fmt),k(e.pool)}catch(s){e("解析JSON失败[".concat(s,"]"))}else try{let e=await O(async()=>b.HQ.import(await s.arrayBuffer()));R(e.fmt),k(e.pool)}catch(s){e("解析二进制文件失败[".concat(s,"]"))}n()}},K=async(e,s)=>{(0,v.Ai)("pb.bin"===s&&v.$j?e:new Blob([await e]),{fileName:I+"."+s,extensions:["."+s],startIn:"downloads"}).then(()=>{S.o.success("弹幕已导出")}).catch(e=>{let s=String(e);S.o.error("弹幕导出失败",s.includes("aborted")?"用户手动取消导出":s)}).finally(()=>z(!1))},Z=async(e,s)=>{z(!0),A(s),_?K(e,s):(z(!1),J.onOpen())};return(0,n.jsxs)("div",{className:"flex flex-col gap-4",children:[(0,n.jsx)("h1",{className:(0,w.D)(),children:"弹幕处理"}),(0,n.jsx)(F,{fileType:M,url:t}),(0,n.jsx)(r.y,{}),L.dans.length>0&&!L.info.fromConverted||(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(a.T,{color:"primary",isLoading:q,onPress:G,children:"读取弹幕"}),(0,n.jsxs)("div",{className:"text-sm text-gray-400",children:["点击",(0,n.jsx)(i.i,{children:"读取弹幕"}),"后，在打开的窗口可选择弹幕类型以筛选文件，也可选择全部文件挑选文件。",(0,n.jsx)("br",{}),"只有",(0,n.jsx)(o.I,{color:"foreground",content:"完全支持",offset:-3,children:(0,n.jsx)(i.i,{children:"@dan-uni/dan-any"})}),"及",(0,n.jsx)(o.I,{color:"foreground",content:"兼容性支持",offset:-3,children:(0,n.jsx)(i.i,{children:"biliy"})}),"导出的ASS可以被还原。"]})]}),L.dans.length>0&&(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(N,{dmPool:L}),(0,n.jsx)(r.y,{}),(0,n.jsx)(D,{dmPool:L}),(0,n.jsx)(r.y,{}),L.info.fromConverted||(0,n.jsxs)(n.Fragment,{children:[(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)("h2",{className:(0,w.V)(),children:"处理选项"}),(0,n.jsxs)("div",{className:"flex flex-wrap gap-4 items-center",children:[(0,n.jsx)("div",{children:(0,n.jsx)(a.T,{color:"danger",isLoading:q,onPress:G,children:"还原全部处理"})}),(0,n.jsx)(r.y,{}),(0,n.jsxs)("div",{className:"flex flex-col gap-2 lg:flex-row",children:[(0,n.jsx)(c.P,{description:"合并一定时间段内的重复弹幕，防止同屏出现过多[0表示不查重]",endContent:(0,n.jsx)("div",{className:"pointer-events-none flex items-center",children:(0,n.jsx)("span",{className:"text-default-400 text-small",children:"秒"})}),label:"去重合并弹幕阈值(查重时间区段)",type:"number",value:V,onValueChange:e=>E(e)}),(0,n.jsx)(a.T,{color:"primary",isLoading:q,onPress:()=>{$(()=>O(()=>{$(()=>k(L.merge(V))),S.o.success("去重成功")}))},children:"去重(基础)"})]})]})]}),(0,n.jsx)(r.y,{})]}),(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)("h2",{className:(0,w.V)(),children:"导出设置"}),(0,n.jsxs)(n.Fragment,{children:[L.info.fromConverted||(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(d.r,{isRequired:!0,endContent:(0,n.jsx)("div",{className:"pointer-events-none flex items-center",children:(0,n.jsxs)("span",{className:"text-default-400 text-small",children:[".",T]})}),isInvalid:Y,label:"文件名称",labelPlacement:"outside",type:"text",value:I,variant:"bordered",onValueChange:B}),(0,n.jsxs)("div",{className:"flex flex-col gap-2 lg:flex-row",children:[(0,n.jsx)(a.T,{color:"primary",isLoading:q,onPress:()=>{Z(O(()=>L.toBiliXML()),"xml")},children:"Bili(XML)"}),(0,n.jsx)(a.T,{color:"primary",isLoading:q,onPress:()=>{let e=document.createElement("canvas");e.width=50,e.height=50;let s=e.getContext("2d");Z(O(()=>L.toASS(s,{filename:"".concat(I,".xml"),title:I,raw:{compressType:"gzip",baseType:"base18384"}})),"ass")},children:"ASS"}),(0,n.jsxs)(x.x,{isDisabled:q,children:[(0,n.jsx)(a.T,{color:"primary",onPress:()=>{Z(O(()=>JSON.stringify(L.dans)),"json")},children:"DanUni(JSON)"}),(0,n.jsx)(a.T,{color:"secondary",onPress:()=>{Z(O(()=>L.toPb()),"pb.bin")},children:"DanUni(ProtoBuf)"})]}),(0,n.jsxs)(x.x,{isDisabled:q,children:[(0,n.jsx)(a.T,{color:"primary",onPress:()=>{Z(O(()=>JSON.stringify(L.toDplayer())),"json")},children:"Dplayer"}),(0,n.jsx)(a.T,{color:"secondary",onPress:()=>{Z(O(()=>JSON.stringify(L.toArtplayer())),"json")},children:"Artplayer"}),(0,n.jsx)(a.T,{color:"default",onPress:()=>{Z(O(()=>JSON.stringify(L.toDDplay())),"json")},children:"弹弹Play"})]})]}),(0,n.jsx)(m.Y,{isOpen:J.isOpen,onOpenChange:J.onOpenChange,children:(0,n.jsx)(h.g,{children:e=>(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(f.c,{children:"⚠️ 兼容性警告"}),(0,n.jsxs)(u.h,{children:[(0,n.jsxs)("p",{children:["当前环境不支持",(0,n.jsx)(p.m,{color:"primary",children:"FileSystemAccessAPI"}),"，点击保存将可能直接存储至",(0,n.jsx)(p.m,{children:"下载"}),"或",(0,n.jsx)(p.m,{children:"Downloads"}),"文件夹。"]}),(0,n.jsx)("p",{children:"确认后再次点击导出格式对应按钮即可保存。"})]}),(0,n.jsxs)(j.q,{children:[(0,n.jsx)(a.T,{color:"danger",variant:"flat",onPress:e,children:"取消"}),(0,n.jsx)(a.T,{color:"primary",onPress:()=>{Q(!0),e()},children:"我已知悉"})]})]})})})]}),(0,n.jsx)(a.T,{color:"danger",isLoading:q,onPress:()=>{let e=()=>S.o.success("导出弹幕完成","已释放缓存");t?(URL.revokeObjectURL(t),e(),s.push("/crawl")):(R(void 0),k(C),U(void 0),e())},children:"确认导出完成(退出)"})]})]})]})]})}},45949:(e,s,t)=>{Promise.resolve().then(t.bind(t,37247))},60518:(e,s,t)=>{"use strict";t.d(s,{D:()=>l,V:()=>r});var n=t(85839);let l=(0,n.tv)({base:"tracking-tight inline font-semibold",variants:{color:{violet:"from-[#FF1CF7] to-[#b249f8]",yellow:"from-[#FF705B] to-[#FFB457]",blue:"from-[#5EA2EF] to-[#0072F5]",cyan:"from-[#00b7fa] to-[#01cfea]",green:"from-[#6FEE8D] to-[#17c964]",pink:"from-[#FF72E1] to-[#F54C7A]",foreground:"dark:from-[#FFFFFF] dark:to-[#4B4B4B]"},size:{sm:"text-3xl lg:text-4xl",md:"text-[2.3rem] lg:text-5xl leading-9",lg:"text-4xl lg:text-6xl"},fullWidth:{true:"w-full block"}},defaultVariants:{size:"md"},compoundVariants:[{color:["violet","yellow","blue","cyan","green","pink","foreground"],class:"bg-clip-text text-transparent bg-gradient-to-b"}]}),r=(0,n.tv)({base:"w-full md:w-1/2 my-2 text-lg lg:text-xl text-default-600 block max-w-full",variants:{fullWidth:{true:"!w-full"}},defaultVariants:{fullWidth:!0}})},72237:(e,s,t)=>{"use strict";t.d(s,{o:()=>l});var n=t(11046);let l={success:(e,s)=>{(0,n.$U)({title:e,description:s,color:"success"})},error:(e,s)=>{(0,n.$U)({title:e,description:s,color:"danger"})},info:(e,s)=>{(0,n.$U)({title:e,description:s,color:"default"})},warning:(e,s)=>{(0,n.$U)({title:e,description:s,color:"warning"})}}}},e=>{e.O(0,[881,302,191,192,151,253,786,987,803,447,358],()=>e(e.s=45949)),_N_E=e.O()}]);