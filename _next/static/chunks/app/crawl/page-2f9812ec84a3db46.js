(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[822],{3851:(e,t,a)=>{Promise.resolve().then(a.bind(a,99325))},57245:(e,t,a)=>{"use strict";a.d(t,{f:()=>n,g:()=>l});var s=a(33146);let n=(0,a(81272).tG)("BACKEND_URL","http://127.0.0.1:28299"),l=(0,s.eU)(2)},60518:(e,t,a)=>{"use strict";a.d(t,{D:()=>n,V:()=>l});var s=a(85839);let n=(0,s.tv)({base:"tracking-tight inline font-semibold",variants:{color:{violet:"from-[#FF1CF7] to-[#b249f8]",yellow:"from-[#FF705B] to-[#FFB457]",blue:"from-[#5EA2EF] to-[#0072F5]",cyan:"from-[#00b7fa] to-[#01cfea]",green:"from-[#6FEE8D] to-[#17c964]",pink:"from-[#FF72E1] to-[#F54C7A]",foreground:"dark:from-[#FFFFFF] dark:to-[#4B4B4B]"},size:{sm:"text-3xl lg:text-4xl",md:"text-[2.3rem] lg:text-5xl leading-9",lg:"text-4xl lg:text-6xl"},fullWidth:{true:"w-full block"}},defaultVariants:{size:"md"},compoundVariants:[{color:["violet","yellow","blue","cyan","green","pink","foreground"],class:"bg-clip-text text-transparent bg-gradient-to-b"}]}),l=(0,s.tv)({base:"w-full md:w-1/2 my-2 text-lg lg:text-xl text-default-600 block max-w-full",variants:{fullWidth:{true:"!w-full"}},defaultVariants:{fullWidth:!0}})},72237:(e,t,a)=>{"use strict";a.d(t,{o:()=>n});var s=a(11046);let n={success:(e,t)=>{(0,s.$U)({title:e,description:t,color:"success"})},error:(e,t)=>{(0,s.$U)({title:e,description:t,color:"danger"})},info:(e,t)=>{(0,s.$U)({title:e,description:t,color:"default"})},warning:(e,t)=>{(0,s.$U)({title:e,description:t,color:"warning"})}}},99325:(e,t,a)=>{"use strict";a.r(t),a.d(t,{default:()=>_});var s=a(60881),n=a(95701),l=a(59110),r=a(18093),c=a(17181),i=a(91529),o=a(63752),d=a(51477),u=a(45001),f=a(60518),h=a(49671),g=a(36073),x=a(72387),m=a(65765),p=a(40737),j=a(96286),y=a(64770),v=a(72237),S=a(57245);function w(e){let{onSuccess:t,isInModal:a=!1}=e,[l,c]=(0,n.useState)(""),[i,o]=(0,n.useState)(""),[d,u]=(0,n.useState)([]),[f,w]=(0,n.useState)([]),[b,C]=(0,n.useState)(!0),[N,k]=(0,n.useState)((0,j.Ec)((0,j.Xj)())),[T,I]=(0,n.useState)((0,j.Ec)((0,j.Xj)())),D=(0,y.md)(S.f),P=async()=>{if(!i.trim())return void v.o.error("请输入 URL 或 CID");try{let e=await fetch("".concat(D,"/videoInfo/getVideoPartList"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({url:i})}),t=await e.json();0===t.code?(u(t.data.cidList),w(t.data.cidList.map(e=>e.cid))):v.o.error("获取分P失败","data.msg")}catch(e){v.o.error("接口请求异常",String(e))}},O=async()=>{if(!l.trim())return void v.o.error("请输入任务名称");if(/[\/\\\*\?\<\>\|":]/.test(l))return void v.o.error('任务名称包含非法字符：/ \\ * ? < > | " :');if(0===d.length)return void v.o.error("请先获取分P列表");let e=(()=>{if(b)return[0,0];let e=(e,t,a,s,n,l)=>Math.floor(Date.UTC(e,t-1,a,s,n,l)/1e3)-28800;return[e(N.year,N.month,N.day,0,0,0),e(T.year,T.month,T.day,23,59,59)]})(),a=e=>e.replace(/[\/\\\*\?\<\>\|":]/g,"_");try{for(let t of d)if(f.includes(t.cid)){let s=a(t.part),n={path:"".concat(l,"/").concat(s),data:t,range:e};await fetch("".concat(D,"/allDm/initTaskConfig"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)})}v.o.success("任务初始化成功"),t()}catch(e){v.o.error("任务初始化失败",String(e))}};return(0,s.jsxs)(h.Z,{className:a?"space-y-4 p-4 shadow-none bg-transparent":"p-4 space-y-4",children:[(0,s.jsx)(g.r,{label:"任务名称",placeholder:"请输入任务名称",value:l,onChange:e=>c(e.target.value)}),(0,s.jsx)(g.r,{label:"URL 或 CID",placeholder:"如果输入cid, 应输入 cid=2233 格式 (无空格)",value:i,onChange:e=>o(e.target.value)}),(0,s.jsx)(r.T,{color:"secondary",onPress:P,children:"获取分P"}),d.length>0&&(0,s.jsx)(x._,{label:"选择需要爬取的分P",value:f.map(String),onValueChange:e=>w(e.map(Number)),children:d.map(e=>(0,s.jsxs)(m.A,{value:String(e.cid),children:[e.page," | ",e.part," | ",e.cid]},e.cid))}),(0,s.jsxs)("div",{className:"flex flex-col gap-3",children:[(0,s.jsx)(m.A,{isSelected:b,size:"md",onChange:e=>C(e.target.checked),children:"爬取全弹幕"}),!b&&(0,s.jsxs)("div",{className:"flex gap-4",children:[(0,s.jsx)(p.g,{isRequired:!0,className:"flex-grow",granularity:"day",label:"开始时间",value:N,onChange:e=>k(e||(0,j.Ec)((0,j.Xj)()))}),(0,s.jsx)(p.g,{isRequired:!0,className:"flex-grow",granularity:"day",label:"结束时间",value:T,onChange:e=>I(e||(0,j.Ec)((0,j.Xj)()))})]})]}),(0,s.jsx)(r.T,{color:"primary",onPress:O,children:"确定并初始化任务"})]})}var b=a(11046),C=a(90467),N=a(21450),k=a(13003),T=a(18070),I=a(7646),D=a(50319),P=a(38912),O=a(61858),F=a(96376);function E(e){let{isOpen:t,onClose:a,configId:l,cid:u,defaultFileName:f}=e,h=(0,O.useRouter)(),[x,p]=(0,n.useState)(f),[j,v]=(0,n.useState)(!1),[w,b]=(0,n.useState)(!1),[C,N]=(0,n.useState)(!1),k=(0,y.md)(S.f);(0,n.useEffect)(()=>{t&&(p("".concat(u,"_").concat(f).replace(/[ \/\\\*\?\<\>\|":]/g,"_")),v(!0))},[t,f]);let T=async()=>{N(!0);try{let e=await fetch("".concat(k,"/allDm/exportXml"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({configId:l,cid:u,fileName:x,includeWeight:j})}),t=e.headers.get("Content-Disposition"),a=x.endsWith(".xml")?x:"".concat(x,".xml");if(t){let e=t.match(/filename\*=(?:UTF-8'')?(.+)/i);e&&(a=decodeURIComponent(e[1]))}let s=await e.blob();if(w){let e=URL.createObjectURL(s);h.push("/dmHandle?url=".concat(e,"&fn=").concat(x))}else(0,F.Ai)(s,{fileName:a,extensions:[".xml"],startIn:"downloads"})}finally{N(!1),a()}};return(0,s.jsx)(c.Y,{isDismissable:!1,isOpen:t,onClose:a,children:(0,s.jsxs)(i.g,{children:[(0,s.jsx)(o.c,{children:"导出弹幕"}),(0,s.jsxs)(d.h,{children:[(0,s.jsx)(g.r,{endContent:(0,s.jsx)("div",{className:"pointer-events-none flex items-center",children:(0,s.jsx)("span",{className:"text-default-400 text-small",children:".xml"})}),label:"文件名称",value:x,onChange:e=>p(e.target.value)}),(0,s.jsx)(m.A,{isSelected:j,onValueChange:v,children:"导出弹幕权重"}),(0,s.jsx)(m.A,{isSelected:w,onValueChange:b,children:"稍后进行弹幕处理"})]}),(0,s.jsxs)(P.q,{children:[(0,s.jsx)(r.T,{color:"default",onPress:a,children:"取消"}),(0,s.jsx)(r.T,{color:"primary",isLoading:C,onPress:T,children:"确认导出"})]})]})})}var U=a(28669),z=a(10801);function A(e){if(0===e)return null;let t=new Date(1e3*e);return new z.ng(t.getFullYear(),t.getMonth()+1,t.getDate())}function R(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return e?Date.UTC(e.year,e.month-1,e.day,23*!!t,59*!!t,59*!!t)/1e3-28800:0}let $=e=>{let{isOpen:t,loading:a,configData:l,onClose:u,onSave:f}=e,[h,x]=(0,n.useState)(""),[y,v]=(0,n.useState)(!0),[S,w]=(0,n.useState)((0,j.Ec)((0,j.Xj)())),[b,C]=(0,n.useState)((0,j.Ec)((0,j.Xj)()));(0,n.useEffect)(()=>{var e,t;if(!l)return;let[a,s]=l.range;x(l.title),v(0===a&&0===s),w(null!=(e=A(a))?e:(0,j.Ec)((0,j.Xj)())),C(null!=(t=A(s))?t:(0,j.Ec)((0,j.Xj)()))},[l]);let N=async()=>{if(!l)return;let e=y?[0,0]:[R(S,!1),R(b,!0)];await f({...l,title:h,range:e})};return(0,s.jsx)(c.Y,{isDismissable:!1,isOpen:t,size:"md",onClose:u,children:(0,s.jsxs)(i.g,{children:[(0,s.jsx)(o.c,{children:"任务配置管理"}),(0,s.jsx)(d.h,{children:a||!l?(0,s.jsx)(U.o,{}):(0,s.jsxs)("div",{className:"space-y-4",children:[(0,s.jsxs)("div",{children:["cid: ",l.cid]}),(0,s.jsx)(g.r,{fullWidth:!0,label:"标题",value:h,onChange:e=>x(e.target.value)}),(0,s.jsxs)("div",{className:"flex flex-col gap-3",children:[(0,s.jsx)(m.A,{isSelected:y,size:"md",onChange:e=>v(e.target.checked),children:"爬取全弹幕"}),!y&&(0,s.jsxs)("div",{className:"flex gap-4",children:[(0,s.jsx)(p.g,{isRequired:!0,className:"flex-grow",granularity:"day",label:"开始时间",value:S,onChange:e=>w(e||(0,j.Ec)((0,j.Xj)()))}),(0,s.jsx)(p.g,{isRequired:!0,className:"flex-grow",granularity:"day",label:"结束时间",value:b,onChange:e=>w(e||(0,j.Ec)((0,j.Xj)()))})]})]})]})}),(0,s.jsxs)(P.q,{children:[(0,s.jsx)(r.T,{color:"secondary",onPress:u,children:"取消"}),(0,s.jsx)(r.T,{color:"primary",disabled:a||!l,onPress:N,children:"保存"})]})]})})},W=new Map;function X(e){let{refreshKey:t}=e,[a,l]=(0,n.useState)([]),c=(0,n.useRef)(new Map),[i,o]=(0,n.useState)(!1),[d,u]=(0,n.useState)(new Set),[f,g]=(0,n.useState)({}),[x,m]=(0,n.useState)({}),[p,j]=(0,n.useState)(!1),[w,P]=(0,n.useState)(null),[O,F]=(0,n.useState)(!1),U=(0,n.useRef)({}),[z,A]=(0,n.useState)(!1),[R,X]=(0,n.useState)(0),[_,L]=(0,n.useState)(""),[J,M]=(0,n.useState)(""),V=(0,y.md)(S.f),B=e=>{let t=c.current.get(e.configId);t&&l(a=>{let s=[...a],n=s[t.groupIndex],l=[...n.tasks];return l[t.taskIndex]=e,s[t.groupIndex]={...n,tasks:l},s})},q=async()=>{let e=await fetch("".concat(V,"/allDm/getAllTaskData")),t=await e.json();l(t.data);var a=t.data;let s=new Map;a.forEach((e,t)=>{e.tasks.forEach((e,a)=>{s.set(e.configId,{groupIndex:t,taskIndex:a})})}),c.current=s},H=e=>0===e?"未开始":T.c9.fromSeconds(e).toFormat("yyyy-MM-dd HH:mm:ss"),Y=(e,t)=>{g(a=>{let s=T.c9.local().toFormat("HH:mm:ss"),n=a[e]||[];return{...a,[e]:[...n.slice(-49),{time:s,message:t}]}})},K=async()=>{let e=await fetch("".concat(V,"/allDm/getAllRuningTask"),{method:"POST"});for(let[t,a]of Object.entries((await e.json()).data)){if("string"!=typeof a){(0,b.$U)({title:String(a),description:"taskId 类型错误: ".concat(t," ->"),color:"warning"});continue}let e=+(t.split("-").pop()||0),s=new WebSocket("".concat(V.replace(/^http/,"ws"),"/allDm/ws/").concat(a));s.onmessage=e=>{try{let a=JSON.parse(e.data);"log"===a.type?Y(t,a.data):"taskConfig"===a.type?B(a.data):(0,b.$U)({title:"未知消息类型",description:String(a),color:"warning"})}catch(t){(0,b.$U)({title:"消息格式错误",description:String(t)+"/n"+e.data,color:"warning"})}},s.onerror=e=>{(0,b.$U)({title:"WebSocket错误(cid: ".concat(t,")"),description:String(e),color:"danger"})},s.onclose=()=>{(0,b.$U)({title:"WebSocket已关闭(cid: ".concat(t,")"),color:"warning"}),U.current[e]&&(U.current[e].close(),delete U.current[e]),W.has(t)&&W.delete(t)},v.o.info("连接到","configId = ".concat(t)),U.current[e]=s,W.set(t,a)}},Z=async(e,t)=>{if(W.has(e.configId))return void v.o.error("任务启动失败","任务已经开始了, 不能再次启动任务; 可以刷新网页再尝试");let a=await fetch("".concat(V,"/allDm/startTask"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({configId:e.configId,cid:e.cid,path:"".concat(t,"/").concat(e.title)})}),s=(await a.json()).data.taskId;W.set(e.configId,s);let n=new WebSocket("".concat(V.replace(/^http/,"ws"),"/allDm/ws/").concat(s));v.o.info("连接到","cid = ".concat(e.cid)),n.onmessage=t=>{try{let a=JSON.parse(t.data);"log"===a.type?Y(e.configId,a.data):"taskConfig"===a.type?B(a.data):(0,b.$U)({title:"未知消息类型",description:a})}catch(e){(0,b.$U)({title:"消息格式错误",description:String(e)+";"+t.data,color:"danger"})}},n.onerror=t=>{(0,b.$U)({title:"WebSocket错误(cid: ".concat(e.cid,")"),description:String(t),color:"danger"})},n.onclose=()=>{(0,b.$U)({title:"WebSocket已关闭(cid: ".concat(e.cid,")"),color:"warning"}),U.current[e.cid]&&(U.current[e.cid].close(),delete U.current[e.cid]),W.has(e.configId)&&W.delete(e.configId)},U.current[e.cid]=n},G=async e=>{if(void 0===W.get(e.configId))return void v.o.error("暂停任务失败","任务并没有开始, 请刷新网页再尝试");await fetch("".concat(V,"/allDm/stopTask/").concat(W.get(e.configId)),{method:"POST"}),W.delete(e.configId),v.o.success("已暂停任务"),q()},Q=async(e,t)=>{j(!0),F(!0);try{let a=await fetch("".concat(V,"/allDm/getTaskConfig/").concat(e,"?cid=").concat(t)),s=await a.json();P(s.data)}finally{j(!1)}},ee=async e=>{await fetch("".concat(V,"/allDm/setTaskConfig"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)}),F(!1),P(null),q()},et=e=>{m(t=>({...t,[e]:!t[e]}))};return(0,n.useEffect)(()=>{q(),K()},[t]),(0,s.jsxs)("div",{className:"space-y-4",children:[(0,s.jsx)(C.D,{children:a.map(e=>(0,s.jsx)(N.R,{title:e.mainTitle,children:e.tasks.map(t=>{var a,n;return(0,s.jsx)(h.Z,{className:"p-4 mb-2",children:(0,s.jsxs)("div",{className:"flex justify-between items-start",children:[(0,s.jsxs)("div",{className:"text-left space-y-1 w-3/4",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("strong",{children:"爬取:"})," ",t.title," (",t.cid,")"]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("strong",{children:"数据:"})," ",t.totalDanmaku," 条 | 神弹幕:"," ",t.advancedDanmaku]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("strong",{children:"进度:"})," ",H(t.currentTime)," ","/ ",H(t.range[1])]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("strong",{children:"上次执行:"})," ",H(t.lastFetchTime)]}),(0,s.jsx)("div",{className:"mt-2 border rounded p-2 in-dark:bg-black in-dark:text-green-400 text-gray-500 text-xs font-mono max-h-40 overflow-y-auto cursor-pointer",role:"button",tabIndex:0,onClick:()=>et(t.configId),onKeyDown:()=>et(t.configId),children:x[t.configId]?(0,s.jsx)(k.H,{hideScrollBar:!0,className:"max-h-40",children:(null==(a=f[t.configId])?void 0:a.map((e,t)=>(0,s.jsxs)("div",{children:["[",e.time,"] ",e.message]},t)))||(0,s.jsx)("div",{children:"暂无日志"})}):(0,s.jsx)("div",{children:(null==(n=f[t.configId])?void 0:n.length)?"[".concat(f[t.configId][f[t.configId].length-1].time,"] ").concat(f[t.configId][f[t.configId].length-1].message):"暂无日志 (点击展开)"})})]}),(0,s.jsxs)("div",{className:"flex flex-col items-end space-y-1 w-1/4",children:[(0,s.jsxs)("div",{className:"font-bold ".concat((e=>{switch(e){case"爬取历史弹幕":case"正在爬取实时弹幕":return"text-green-500";case"暂停爬取历史弹幕":case"暂停爬取实时弹幕":return"text-yellow-500";case"爬取历史弹幕完成":return"text-blue-500";case"爬取历史弹幕被封禁中":case"实时弹幕被封禁中":return"text-red-500";default:return"text-default-500"}})(t.status)),children:[t.status," ",i&&(0,s.jsx)("input",{checked:d.has(t.configId),type:"checkbox",onChange:()=>{var e;return e=t.configId,void u(t=>{let a=new Set(t);return a.has(e)?a.delete(e):a.add(e),a})}})]}),(0,s.jsx)(r.T,{color:"primary",size:"sm",onPress:()=>Z(t,e.mainTitle),children:"运行"}),(0,s.jsx)(r.T,{color:"warning",size:"sm",onPress:()=>G(t),children:"暂停"}),(0,s.jsx)(r.T,{color:"secondary",size:"sm",onPress:()=>Q(t.configId,t.cid),children:"配置"}),(0,s.jsx)(r.T,{color:"default",size:"sm",onPress:()=>{var e,a,s;return e=t.configId,a=t.cid,s=t.title,void(L(e),X(a),M(s),A(!0))},children:"导出弹幕"})]})]})},t.cid)})},e.mainTitle))}),i?(0,s.jsxs)("div",{className:"fixed bottom-20 right-8 z-50 flex space-x-4",children:[(0,s.jsx)(r.T,{className:"shadow-xl rounded-full px-6 py-4 text-base",color:"danger",disabled:0===d.size,size:"sm",startContent:(0,s.jsx)(I.A,{size:20}),onPress:async()=>{confirm("确定删除 ".concat(d.size," 个任务吗？"))&&(await fetch("".concat(V,"/allDm/deleteTasks"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({configIds:Array.from(d)})}),u(new Set),o(!1),q())},children:"删除"}),(0,s.jsx)(r.T,{className:"shadow-xl rounded-full px-6 py-4 text-base",color:"default",size:"sm",onPress:()=>{u(new Set),o(!1)},children:"取消"})]}):(0,s.jsx)(r.T,{className:"fixed bottom-20 right-8 shadow-xl rounded-full px-6 py-4 text-base",color:"secondary",size:"sm",startContent:(0,s.jsx)(D.A,{size:20}),onPress:()=>o(!0),children:"管理任务"}),(0,s.jsx)(E,{cid:R,configId:_,defaultFileName:J,isOpen:z,onClose:()=>A(!1)}),(0,s.jsx)($,{configData:w,isOpen:O,loading:p,onClose:()=>{F(!1),P(null)},onSave:ee},(null==w?void 0:w.cid)||0)]})}function _(){let[e,t]=(0,n.useState)(0),[a,h]=(0,n.useState)(!1);return(0,s.jsxs)("div",{className:"w-full flex flex-col flex-grow relative",children:[(0,s.jsx)("h1",{className:(0,f.D)(),children:"任务管理"}),(0,s.jsx)(l.f,{y:4}),(0,s.jsx)(X,{refreshKey:e}),(0,s.jsx)(r.T,{className:"fixed bottom-8 right-8 shadow-xl rounded-full px-6 py-4 text-base",color:"primary",isIconOnly:!1,startContent:(0,s.jsx)(u.A,{size:20}),onPress:()=>h(!0),children:"新建任务"}),(0,s.jsx)(c.Y,{className:"max-w-4xl w-full",isDismissable:!1,isOpen:a,size:"xl",onOpenChange:h,children:(0,s.jsxs)(i.g,{className:"flex flex-col h-[80vh]",children:[(0,s.jsx)(o.c,{children:"新建任务"}),(0,s.jsx)(d.h,{className:"flex-1 overflow-hidden",children:(0,s.jsx)("div",{className:"h-full overflow-y-auto px-1",children:(0,s.jsx)(w,{isInModal:!0,onSuccess:()=>{t(e=>e+1),h(!1)}})})})]})})]})}}},e=>{e.O(0,[302,191,193,192,717,253,786,486,803,447,358],()=>e(e.s=3851)),_N_E=e.O()}]);